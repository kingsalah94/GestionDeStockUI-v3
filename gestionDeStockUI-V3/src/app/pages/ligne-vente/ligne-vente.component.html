<div class="containers" style="display: flex; gap: 16px; align-items: flex-start;">
  <!-- Zone principale -->
  <mat-card style="flex: 1 1 auto;">
    <mat-card-header>
      <mat-card-title>
        <mat-icon class="me-2">point_of_sale</mat-icon> Ventes / Commandes Client
      </mat-card-title>
    </mat-card-header>
    <mat-divider></mat-divider>

    <mat-card-content>
      <!-- Filtres + Actions -->
      <div class="spacer" style="display: flex; gap: 16px; align-items: center; margin-bottom: 16px;">
        <mat-form-field appearance="outline" style="flex: 1;">
          <mat-label><mat-icon>filter_list</mat-icon> Filtrer</mat-label>
          <input matInput #searchInput placeholder="Rechercher par client, date, statut..." (input)="onFilterTextChange(searchInput.value)" />

        </mat-form-field>
        <mat-form-field appearance="outline" style="width: 200px;">
          <mat-label><mat-icon>credit_card</mat-icon> Paiement</mat-label>
          <mat-select [(ngModel)]="filtrePaiement" (selectionChange)="appliquerFiltres()">
            <mat-option value="">Tous</mat-option>
            <mat-option value="Payé">Payé</mat-option>
            <mat-option value="Non payé">Non payé</mat-option>
          </mat-select>
        </mat-form-field>

        <button mat-raised-button color="accent" (click)="exportVentesCSV()">
          <mat-icon>cloud_upload</mat-icon> Export
        </button>

        <input type="file" #fileInput style="display: none" accept=".csv" (change)="importVentesCSV($event)">
        <button mat-raised-button color="accent" (click)="fileInput.click()">
          <mat-icon>cloud_download</mat-icon> Import
        </button>

        <button mat-raised-button color="primary" (click)="toggleAddVente()">
          <mat-icon>add_circle</mat-icon> Nouvelle Vente
        </button>
      </div>

      <!-- Tableau des ventes -->
      <table mat-table [dataSource]="venteDataSource" class="mat-elevation-z8" matSort>
        <!-- Colonnes -->
        <ng-container matColumnDef="id">
          <th mat-header-cell *matHeaderCellDef>ID</th>
          <td mat-cell *matCellDef="let element">{{ element.id }}</td>
        </ng-container>

        <ng-container matColumnDef="client">
          <th mat-header-cell *matHeaderCellDef>Client</th>
          <td mat-cell *matCellDef="let element">{{ element.client }}</td>
        </ng-container>

        <ng-container matColumnDef="date">
          <th mat-header-cell *matHeaderCellDef>Date</th>
          <td mat-cell *matCellDef="let element">{{ element.date | date }}</td>
        </ng-container>

        <ng-container matColumnDef="totalHT">
          <th mat-header-cell *matHeaderCellDef>Total HT</th>
          <td mat-cell *matCellDef="let element">{{ element.totalHT }} FCFA</td>
        </ng-container>

        <ng-container matColumnDef="totalTTC">
          <th mat-header-cell *matHeaderCellDef>Total TTC</th>
          <td mat-cell *matCellDef="let element">{{ element.totalTTC }} FCFA</td>
        </ng-container>

        <ng-container matColumnDef="status">
          <th mat-header-cell *matHeaderCellDef>Statut</th>
          <td mat-cell *matCellDef="let element">
            <span [ngClass]="{
              'text-success': element.status === 'Livrée',
              'text-warning': element.status === 'En attente',
              'text-info': element.status === 'Validée'
            }">{{ element.status }}</span>
          </td>
        </ng-container>
        <!-- Paiement -->
        <ng-container matColumnDef="paiement">
          <th mat-header-cell *matHeaderCellDef>Paiement</th>
          <td mat-cell *matCellDef="let element">
            <button *ngIf="element.paiement === 'Non payé'"
                    mat-button
                    color="warn"
                    (click)="simulerPaiement(element)">
              <mat-icon>payment</mat-icon> Payer
            </button>
            <span *ngIf="element.paiement === 'Payé'" class="text-success">
                <mat-icon>check_circle</mat-icon> Payé
            </span>
          </td>
        </ng-container>

        <ng-container matColumnDef="actions">
          <th mat-header-cell *matHeaderCellDef>Actions</th>
          <td mat-cell *matCellDef="let element">
            <button mat-icon-button color="primary" (click)="viewDetails(element)">
              <mat-icon>visibility</mat-icon>
            </button>
            <button mat-icon-button color="accent" (click)="editVente(element)">
              <mat-icon>edit</mat-icon>
            </button>
            <button mat-icon-button color="warn" (click)="deleteVente(element.id)">
              <mat-icon>delete</mat-icon>
            </button>
          </td>
        </ng-container>

        <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
        <tr mat-row *matRowDef="let row; columns: displayedColumns;"></tr>
      </table>

      <mat-paginator [pageSizeOptions]="[5, 10, 25, 100]" showFirstLastButtons></mat-paginator>
    </mat-card-content>
  </mat-card>

  <!-- Formulaire latéral pour ajout/édition -->
  <mat-card *ngIf="showVenteForm" style="width: 400px;">
    <mat-card-header>
      <mat-card-title>{{ editMode ? 'Modifier Vente' : 'Nouvelle Vente' }}</mat-card-title>
    </mat-card-header>
    <mat-divider></mat-divider>
    <mat-card-content style="padding: 10px">

      <!-- Client -->
      <mat-form-field appearance="outline" class="full-width">
        <mat-label>Client</mat-label>
        <input matInput [(ngModel)]="venteForm.client" />
      </mat-form-field>

      <!-- Articles -->
      <mat-form-field appearance="outline" class="full-width">
        <mat-label>Articles</mat-label>
        <mat-select multiple [(ngModel)]="venteForm.articles">
          <mat-option *ngFor="let article of stock" [value]="article">{{ article.article }}</mat-option>
        </mat-select>
      </mat-form-field>

      <!-- Statut -->
      <mat-form-field appearance="outline" class="full-width">
        <mat-label>Statut</mat-label>
        <mat-select [(ngModel)]="venteForm.status">
          <mat-option value="En attente">En attente</mat-option>
          <mat-option value="Validée">Validée</mat-option>
          <mat-option value="Livrée">Livrée</mat-option>
        </mat-select>
      </mat-form-field>

      <!-- Total (affiché, calculé automatiquement dans le TS) -->
      <div class="summary">
        <p><strong>Total HT:</strong> {{ venteForm.totalHT }} FCFA</p>
        <p><strong>TVA:</strong> {{ venteForm.totalTVA }} %</p>
        <p><strong>Total TTC:</strong> {{ venteForm.totalTTC }} FCFA</p>
      </div>

      <!-- Boutons -->
      <div style="text-align: right; margin-top: 16px;">
        <button mat-button (click)="cancelVenteForm()">Annuler</button>
        <button mat-raised-button color="primary" (click)="saveVente()">
          {{ editMode ? 'Modifier' : 'Valider' }}
        </button>
      </div>

    </mat-card-content>
  </mat-card>
</div>
